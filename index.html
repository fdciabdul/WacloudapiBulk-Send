
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Message Sender</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" >

    <!-- DataTables CSS -->

    <!-- SheetJS Libraries -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>

  <!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js" ></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap4.min.js"></script>


    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="container mt-4">
  <div class="modal" id="progressModal" tabindex="-1" role="dialog" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">Sending Messages</h5>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p id="progressText">0%</p>
            </div>
        </div>
    </div>
</div>
    <div class="form-group">
        <label for="token">Access Token:</label>
        <input type="text" id="token" class="form-control" value="<?= localStorage.getItem('token') ?>" />

        <label for="phoneId">Phone ID:</label>
        <input type="text" id="phoneId" class="form-control" value="<?= localStorage.getItem('phoneId') ?>" />

        <label for="wabaId">WABA ID:</label>
        <input type="text" id="wabaId" class="form-control" value="<?= localStorage.getItem('wabaId') ?>" />

        <label for="template">Select Template:</label>
        <select id="template" class="form-control">
            <!-- Options will be populated dynamically using JavaScript -->
        </select>

        <button onclick="showTemplates()" class="btn btn-primary mt-2">Show Templates</button>
        <button onclick="sendMessage()" class="btn btn-success mt-2">Send Messages</button>
    </div>

    <input type="file" id="fileInput" class="mt-3" />
        <table id="dataTable" class="table">
            <thead>
                <!-- Table header will be populated dynamically -->
            </thead>
            <tbody>
                <!-- Table body will be populated dynamically -->
            </tbody>
        </table>
  

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('fileInput').addEventListener('change', handleFile);
        });

        // Load values from localStorage on page load
        document.getElementById('token').value = localStorage.getItem('token') || '';
        document.getElementById('phoneId').value = localStorage.getItem('phoneId') || '';
        document.getElementById('wabaId').value = localStorage.getItem('wabaId') || '';

        function handleFile(event) {
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    const tableData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const headers = tableData[0];
                    const rows = tableData.slice(1);

                    renderDataTable(headers, rows);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function renderDataTable(headers, rows) {
    $(document).ready(function () {
        const dataTable = new DataTable('#dataTable',
        {  data: rows,
            columns: headers.map(header => ({ title: header })),
          
            "order": [] // Disable initial sorting
        });
        // Show the table container
        document.getElementById('tableContainer').style.display = 'block';
    });
}


        function showTemplates() {
            const token = document.getElementById('token').value;
            const wabaId = document.getElementById('wabaId').value;

            // Save values to localStorage
            localStorage.setItem('token', token);
            localStorage.setItem('phoneId', document.getElementById('phoneId').value);
            localStorage.setItem('wabaId', wabaId);

            // Validation
            if (!token || !wabaId) {
                alert('Please fill in all required fields (Access Token and WABA ID)');
                return;
            }

            axios.get(`https://graph.facebook.com/v16.0/${wabaId}/message_templates`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                const templates = response.data.data;

                if (templates.length === 0) {
                    alert('No templates found.');
                    return;
                }

                const templateSelect = document.getElementById('template');
                templateSelect.innerHTML = templates.map(template => {
                    return `<option value="${template.name}_${template.language}">${template.name} (${template.language})</option>`;
                }).join('');
            })
            .catch(error => {
                console.error(error);
            });
        }

        function sendMessage() {
        const token = document.getElementById('token').value;
        const phoneId = document.getElementById('phoneId').value;
        const wabaId = document.getElementById('wabaId').value;
        const templateValue = document.getElementById('template').value;

        // Validation
        if (!token || !phoneId || !wabaId) {
            alert('Please fill in all required fields (Access Token, Phone ID, and WABA ID)');
            return;
        }

        // Show the progress modal
        $('#progressModal').modal({ backdrop: 'static', keyboard: false });

        // Split the templateValue into name and language
        const [templateName, languageCode] = templateValue.split('_');

        const table = new DataTable('#dataTable');
        const recipientWaIds = table.column(1).data().toArray();
        const totalRecipients = recipientWaIds.length;
        let completedRecipients = 0;

        function updateProgress() {
            completedRecipients++;
            const progress = (completedRecipients / totalRecipients) * 100;

            $('#progressBar').css('width', progress + '%');
            $('#progressText').text(progress.toFixed(2) + '%');

            if (completedRecipients === totalRecipients) {
                $('#progressModal').modal('hide');
            }
        }

        recipientWaIds.forEach(recipientWaId => {
            const apiUrl = `https://graph.facebook.com/v16.0/${phoneId}/messages`;
            const payload = {
                messaging_product: "whatsapp",
                to: recipientWaId,
                type: "template",
                template: {
                    name: templateName,
                    language: {
                        code: languageCode
                    }
                }
            };

            axios.post(apiUrl, payload, {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                console.log(response.data);
                updateProgress();
            })
            .catch(error => {
                console.error(error);
                updateProgress();
            });
        });
    }
</script>

    </script>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html>
